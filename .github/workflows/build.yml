name: build

on:
  # Manual trigger (quick testing after code changes)
  workflow_dispatch:

  # CI builds for code changes (NO releases created here)
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

  # Attach binaries ONLY when you create a GitHub Release
  release:
    types: [created]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

permissions:
  contents: write  # Required to upload assets to a GitHub Release

env:
  EXIFTOOL_VER: "13.45"
  EXIFTOOL_DIR: "tools/exiftool"
  PIP_DISABLE_PIP_VERSION_CHECK: "1"
  PIP_NO_PYTHON_VERSION_WARNING: "1"
  PYTHONUNBUFFERED: "1"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        os: [windows-latest, macos-latest]
    runs-on: ${{ matrix.os }}
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"
          cache-dependency-path: |
            requirements.txt

      - name: Sanity check
        shell: bash
        run: |
          set -euo pipefail
          test -f requirements.txt
          test -f date-renamer.spec
          test -f date-renamer.py
          test -d assets

          # Branding assets must exist (at least one per OS)
          test -f assets/DateRenamer.ico || true
          test -f assets/DateRenamer.icns || true

      - name: Install deps (pinned toolchain)
        shell: bash
        run: |
          set -euo pipefail
          python -m pip install -r requirements.txt
          python -m pip install "pyinstaller==6.18.0" "pyinstaller-hooks-contrib==2026.0"

      # --------------------
      # ExifTool (Windows)
      # --------------------
      - name: Fetch ExifTool (Windows 64-bit)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          $ver  = "${{ env.EXIFTOOL_VER }}"
          $dest = "${{ env.EXIFTOOL_DIR }}"

          if (Test-Path $dest) { Remove-Item $dest -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $dest | Out-Null

          $zip = Join-Path $env:TEMP "exiftool-win64.zip"
          $url = "https://sourceforge.net/projects/exiftool/files/exiftool-$ver`_64.zip/download"
          & curl.exe -L --fail --retry 5 --retry-delay 2 -o $zip $url

          $bytes = [System.IO.File]::ReadAllBytes($zip)
          if ($bytes.Length -lt 4 -or $bytes[0] -ne 0x50 -or $bytes[1] -ne 0x4B) {
            throw "Downloaded file is not a ZIP (missing PK header)."
          }

          $extract = Join-Path $env:TEMP "exiftool_extracted"
          if (Test-Path $extract) { Remove-Item $extract -Recurse -Force }
          New-Item -ItemType Directory -Force -Path $extract | Out-Null

          Add-Type -AssemblyName System.IO.Compression.FileSystem
          [System.IO.Compression.ZipFile]::ExtractToDirectory($zip, $extract, $true)

          $top = Get-ChildItem $extract -Directory | Where-Object { $_.Name -like "exiftool-*_64" } | Select-Object -First 1
          if (-not $top) { throw "Top folder exiftool-*_64 not found in ZIP" }

          $kexe = Get-ChildItem $top.FullName -File -Recurse | Where-Object { $_.Name -ieq "exiftool(-k).exe" } | Select-Object -First 1
          if (-not $kexe) { throw "exiftool(-k).exe not found" }

          Copy-Item $kexe.FullName (Join-Path $dest "exiftool.exe") -Force

          $filesDir = Join-Path $top.FullName "exiftool_files"
          if (-not (Test-Path $filesDir)) { throw "exiftool_files missing" }
          Copy-Item $filesDir (Join-Path $dest "exiftool_files") -Recurse -Force

          # Quick verify
          & (Join-Path $dest "exiftool.exe") -ver

      # --------------------
      # ExifTool (macOS)
      # --------------------
      - name: Fetch ExifTool (macOS full distribution)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          ver="${EXIFTOOL_VER}"
          dest="${EXIFTOOL_DIR}"
          rm -rf "$dest"
          mkdir -p "$dest"

          tgz="/tmp/Image-ExifTool.tar.gz"
          url="https://sourceforge.net/projects/exiftool/files/Image-ExifTool-${ver}.tar.gz/download"
          curl -L --fail --retry 5 --retry-delay 2 "$url" -o "$tgz"

          tar -xzf "$tgz" -C "$dest"
          subdir="$(find "$dest" -maxdepth 1 -type d -name "Image-ExifTool-*" | head -n 1)"
          test -n "$subdir"
          cp -R "$subdir/"* "$dest/"
          rm -rf "$subdir"

          # Remove test suite (important for PyInstaller + size)
          rm -rf "$dest/t"

          # Make executable (build-time)
          chmod +x "$dest/exiftool" || true

          # Verify (uses system perl)
          perl "$dest/exiftool" -ver

      - name: Clean build output
        shell: bash
        run: |
          set -euo pipefail
          rm -rf dist build

      - name: Build (PyInstaller)
        shell: bash
        run: |
          set -euo pipefail
          pyinstaller --noconfirm --clean date-renamer.spec

      # --------------------
      # Normalize output names (stable filenames for assets)
      # --------------------
      - name: Normalize output filename (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference="Stop"
          if (!(Test-Path "dist/DateRenamer.exe")) { throw "dist/DateRenamer.exe not found" }
          Move-Item -Force "dist/DateRenamer.exe" "dist/DateRenamer-windows.exe"

      - name: Normalize output filename (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          test -f "dist/DateRenamer"
          mv "dist/DateRenamer" "dist/DateRenamer-macos"
          chmod +x "dist/DateRenamer-macos" || true

      # --------------------
      # Checksums
      # --------------------
      - name: SHA256 (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $h = (Get-FileHash "dist/DateRenamer-windows.exe" -Algorithm SHA256).Hash.ToLower()
          "$h  DateRenamer-windows.exe" | Out-File -Encoding ascii "dist/DateRenamer-windows.exe.sha256"

      - name: SHA256 (macOS)
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          shasum -a 256 "dist/DateRenamer-macos" | awk '{print $1 "  DateRenamer-macos"}' > "dist/DateRenamer-macos.sha256"

      # --------------------
      # Package macOS as ZIP (avoids execute-bit/quarantine issues)
      # --------------------
      - name: Package macOS ZIP
        if: runner.os == 'macOS'
        shell: bash
        run: |
          set -euo pipefail
          cd dist
          rm -f "DateRenamer-macos.zip"
          zip -9 "DateRenamer-macos.zip" "DateRenamer-macos" "DateRenamer-macos.sha256"
          test -f "DateRenamer-macos.zip"

      # ==========================================================
      # RELEASE ASSETS
      # - Windows: direct .exe + .sha256 (no zip)
      # - macOS: zip containing binary + sha256
      # Runs ONLY when a GitHub Release is created (release.created).
      # ==========================================================
      - name: Upload Release Assets (Windows)
        if: runner.os == 'Windows' && github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            dist/DateRenamer-windows.exe
            dist/DateRenamer-windows.exe.sha256
          fail_on_unmatched_files: true

      - name: Upload Release Assets (macOS)
        if: runner.os == 'macOS' && github.event_name == 'release'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.release.tag_name }}
          files: |
            dist/DateRenamer-macos.zip
          fail_on_unmatched_files: true

      # ==========================================================
      # CI TESTING ARTIFACTS (GitHub delivers these as ZIP by design)
      # Runs on pushes/PRs/manual runs (NOT on release events).
      # ==========================================================
      - name: Upload artifact (Windows)
        if: runner.os == 'Windows' && github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: DateRenamer-windows
          path: |
            dist/DateRenamer-windows.exe
            dist/DateRenamer-windows.exe.sha256
          if-no-files-found: error

      - name: Upload artifact (macOS)
        if: runner.os == 'macOS' && github.event_name != 'release'
        uses: actions/upload-artifact@v4
        with:
          name: DateRenamer-macos
          path: |
            dist/DateRenamer-macos.zip
          if-no-files-found: error
